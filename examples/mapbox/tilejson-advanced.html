<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Advanced TileJSON - xpublish-tiles</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
#controls {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255,255,255,0.95);
    padding: 15px;
    border-radius: 8px;
    font-size: 12px;
    max-width: 350px;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
#controls h3 { margin: 0 0 10px 0; color: #333; }
#controls .section { margin-bottom: 15px; }
#controls .section:last-child { margin-bottom: 0; }
#controls label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
#controls select, #controls input { width: 100%; padding: 5px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 3px; }
#controls button {
    background: #007cbf;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 5px;
    margin-bottom: 5px;
}
#controls button:hover { background: #005a87; }
#controls .info { font-size: 11px; color: #666; margin-top: 5px; }
#controls .error { color: #d32f2f; font-size: 11px; margin-top: 5px; }
#controls .success { color: #388e3c; font-size: 11px; margin-top: 5px; }
</style>
</head>
<body>
<div id="map"></div>
<div id="controls">
    <h3>Advanced TileJSON Demo</h3>

    <div class="section">
        <label for="variable">Variable:</label>
        <select id="variable">
            <option value="2t">2t (Temperature)</option>
            <option value="10u">10u (U-wind)</option>
            <option value="10v">10v (V-wind)</option>
        </select>
    </div>

    <div class="section">
        <label for="style">Style:</label>
        <select id="style">
            <option value="raster/viridis">Viridis</option>
            <option value="raster/plasma">Plasma</option>
            <option value="raster/inferno">Inferno</option>
            <option value="raster/magma">Magma</option>
            <option value="raster/cividis">Cividis</option>
        </select>
    </div>

    <div class="section">
        <label for="colorscale">Color Scale Range:</label>
        <input type="text" id="colorscale" value="280,300" placeholder="min,max">
    </div>

    <div class="section">
        <label for="time">Valid Time:</label>
        <input type="datetime-local" id="time" value="2025-04-03T06:00">
    </div>

    <div class="section">
        <label for="crs">Coordinate System:</label>
        <select id="crs">
            <option value="WebMercatorQuad">Web Mercator (3857)</option>
            <option value="WorldCRS84Quad">Geographic (4326)</option>
        </select>
    </div>

    <div class="section">
        <button onclick="loadTileJSON()">Load TileJSON</button>
        <button onclick="showTileJSONSpec()">Show Spec</button>
        <div id="status"></div>
    </div>

    <div class="section">
        <div class="info">
            <strong>Current Layer:</strong> <span id="current-layer">None</span><br>
            <strong>Zoom Range:</strong> <span id="zoom-range">N/A</span><br>
            <strong>Bounds:</strong> <span id="bounds">N/A</span>
        </div>
    </div>
</div>

<script>
	// TO MAKE THE MAP APPEAR YOU MUST
	// ADD YOUR ACCESS TOKEN FROM
	// https://account.mapbox.com
	mapboxgl.accessToken = 'pk.eyJ1IjoibXBpYW5udWNjaSIsImEiOiJja3FiZHg2emEwMGNjMndvY2F6OTdpcWN3In0.rjzyODwHa4rsEy2CH7IDwQ';

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        zoom: 2,
        center: [-71.0367, 42.3739]
    });

    let currentTileJSON = null;
    let currentLayerId = null;

    function updateStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        statusDiv.className = type;
        statusDiv.textContent = message;
    }

    function updateLayerInfo(tilejson) {
        document.getElementById('current-layer').textContent = tilejson.name || 'Unnamed';
        document.getElementById('zoom-range').textContent = `${tilejson.minzoom || 0} - ${tilejson.maxzoom || 18}`;
        document.getElementById('bounds').textContent = tilejson.bounds ?
            `[${tilejson.bounds.map(b => b.toFixed(1)).join(', ')}]` : 'N/A';
    }

    function buildTileJSONUrl() {
        const variable = document.getElementById('variable').value;
        const style = document.getElementById('style').value;
        const colorscale = document.getElementById('colorscale').value;
        const time = document.getElementById('time').value;
        const crs = document.getElementById('crs').value;

        // Convert datetime-local to ISO format
        const isoTime = time ? new Date(time).toISOString() : '2025-04-03T06:00:00';

        const params = new URLSearchParams({
            variables: variable,
            style: style,
            colorscalerange: colorscale,
            width: '256',
            height: '256',
            valid_time: isoTime
        });

        return `http://localhost:8080/datasets/earthmover-public%2Faifs-outputs/tiles/${crs}/tilejson.json?${params}`;
    }

    async function loadTileJSON() {
        updateStatus('Loading TileJSON...', 'info');

        try {
            const url = buildTileJSONUrl();
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const tilejson = await response.json();
            currentTileJSON = tilejson;

            // Remove existing layer if present
            if (currentLayerId && map.getLayer(currentLayerId)) {
                map.removeLayer(currentLayerId);
                map.removeSource(currentLayerId + '-source');
            }

            // Generate unique layer ID
            currentLayerId = 'tilejson-layer-' + Date.now();

            // Add new source and layer
            map.addSource(currentLayerId + '-source', {
                'type': 'raster',
                'tiles': tilejson.tiles,
                'tileSize': 256,
                'minzoom': tilejson.minzoom || 0,
                'maxzoom': tilejson.maxzoom || 18,
                'bounds': tilejson.bounds,
                'attribution': tilejson.attribution
            });

            map.addLayer({
                'id': currentLayerId,
                'type': 'raster',
                'source': currentLayerId + '-source',
                'paint': {
                    'raster-opacity': 0.7
                }
            });

            // Update UI
            updateLayerInfo(tilejson);
            updateStatus('TileJSON loaded successfully!', 'success');

            // Optionally fly to bounds
            if (tilejson.bounds && tilejson.bounds.length === 4) {
                const [west, south, east, north] = tilejson.bounds;
                map.fitBounds([[west, south], [east, north]], { padding: 50 });
            }

        } catch (error) {
            console.error('Error loading TileJSON:', error);
            updateStatus(`Error: ${error.message}`, 'error');
        }
    }

    function showTileJSONSpec() {
        if (!currentTileJSON) {
            updateStatus('No TileJSON loaded yet', 'error');
            return;
        }

        // Create a popup with the TileJSON specification
        const popup = new mapboxgl.Popup({ maxWidth: '500px' })
            .setLngLat(map.getCenter())
            .setHTML(`
                <h4>TileJSON Specification</h4>
                <pre style="font-size: 10px; max-height: 300px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 3px;">${JSON.stringify(currentTileJSON, null, 2)}</pre>
            `)
            .addTo(map);
    }

    map.on('load', () => {
        map.setFog({});

        // Load initial TileJSON
        loadTileJSON();
    });

    map.on('click', function(e) {
        const coordinates = e.lngLat;
        new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(`
                <strong>Coordinates:</strong><br>
                Lng: ${coordinates.lng.toFixed(4)}<br>
                Lat: ${coordinates.lat.toFixed(4)}<br>
                <em>Click "Show Spec" to see TileJSON details</em>
            `)
            .addTo(map);
    });

    // Set initial datetime
    document.getElementById('time').value = '2025-04-03T06:00';
</script>

</body>
</html>
